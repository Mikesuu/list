name: è‡ªåŠ¨æ›´æ–°ç­–ç•¥è·¯ç”±åˆ—è¡¨

on:
  workflow_dispatch:  
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œä¸€æ¬¡
    - cron: '0 0 * * *' 
  push:
    paths:
      - 'src/**' 

jobs:
  generate_mikrotik_list:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œè§£å†³ 403 é”™è¯¯
    permissions:
      contents: write 
    
    steps:
      - name: æ£€å‡ºä»£ç  (ä¿®å¤å†²çª)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # å…³é”®ä¿®å¤ 1ï¼šæ‹‰å–å®Œæ•´çš„ git å†å²
          fetch-depth: 0
          
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: å®‰è£…ä¾èµ–
        run: pip install requests 

      - name: è¿è¡Œ Python è„šæœ¬ç”Ÿæˆ RSC æ–‡ä»¶
        run: python src/domain_processor.py

      - name: æ£€æŸ¥å¹¶æäº¤æ›´æ”¹
        id: commit_check
        run: |
          git status
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
      - name: æäº¤æ›´æ–°åˆ°ä»“åº“
        if: steps.commit_check.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add fwd-ip-list.rsc
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç­–ç•¥è·¯ç”± IP åˆ—è¡¨"
          # å…³é”®ä¿®å¤ 2ï¼šåœ¨æ¨é€å‰åˆå¹¶è¿œç¨‹æ›´æ”¹ï¼Œè§£å†³æ¨é€å†²çª
          git pull --rebase origin main 
          git push
