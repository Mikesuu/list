name: è‡ªåŠ¨æ›´æ–°ç­–ç•¥è·¯ç”±åˆ—è¡¨

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´æ—©ä¸Š 8:00)
    - cron: '0 0 * * *' 
  push:
    paths:
      - 'src/**' # è„šæœ¬æ›´æ–°æ—¶ä¹Ÿè¿è¡Œ

jobs:
  generate_mikrotik_list:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        # å¿…é¡»å…è®¸æ‹‰å–å’Œæ¨é€ï¼Œä»¥ä¾¿åç»­æäº¤æ–‡ä»¶
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: å®‰è£…ä¾èµ–
        run: pip install requests dnspython

      - name: è¿è¡Œ Python è„šæœ¬ç”Ÿæˆ RSC æ–‡ä»¶
        run: python src/domain_processor.py

      - name: æ£€æŸ¥å¹¶æäº¤æ›´æ”¹
        id: commit_check
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®é™…å˜åŒ–
          git status
          if [ -n "$(git status --porcelain)" ]; then
            echo "::set-output name=has_changes::true"
          else
            echo "::set-output name=has_changes::false"
          fi
          
      - name: æäº¤æ›´æ–°åˆ°ä»“åº“
        if: steps.commit_check.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add fwd-ip-list.rsc
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç­–ç•¥è·¯ç”± IP åˆ—è¡¨"
          git push
